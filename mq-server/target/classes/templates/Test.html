<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../static/layui/css/layui.css">
    <script src="../static/layui/layui.js"></script>
    <script src="../static/js/jquery.min.js"></script>
</head>
<body>
<button type="button" class="layui-btn" id="upload">
    <i class="layui-icon">&#xe67c;</i>上传文件到当前文件夹
</button>
<button class="layui-btn layui-btn-normal" id = "pageUp" onclick="back()">上一层</button>
<button class="layui-btn layui-btn-warm" onclick="createFolderForm()">新建文件夹</button>

<table id="folder" lay-filter="folder"></table>
<table id="file" lay-filter="file"></table>

<script type="text/html" id="barDemo">
    <!--<a class="layui-btn layui-btn-xs" lay-event="detail">查看</a>-->
    <!--<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>-->
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<script>
    var relativePath = "";
    function addData() {
        layui.use('table', function(){
            var table = layui.table;
            //第一个实例
            table.render({
                elem: '#file'
                ,height: 315
                ,url: 'http://localhost:8002/showFile' //数据接口
                ,where: {
                    'account' : 15927860204,
                    'relativePath' : relativePath
                }
                ,page: true //开启分页
                ,limit: 10
                ,cols: [[ //表头
                    {type: 'checkbox'},
                    {field: 'fileName', title: '文件名', width:800, event:"click"},
                    {fixed: 'right', width:150, align:'center', toolbar: '#barDemo'}
                ]]
            });
            table.render({
                elem: '#folder'
                ,height: 315
                ,url: 'http://localhost:8002/showFolder' //数据接口
                ,where: {
                    'account' : 15927860204,
                    'relativePath' : relativePath
                }
                ,page: true //开启分页
                ,limit: 10
                ,cols: [[ //表头
                    {type: 'checkbox'},
                    {field: 'indexName', title: '文件夹名', width:800, event:"indexClick"},
                    {fixed: 'right', width:150, align:'center', toolbar: '#barDemo'}
                ]]
            });
            table.on('tool(folder)', function(obj){
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象
                if (layEvent === "indexClick") {
                    if (relativePath === "") {
                        relativePath = data.indexName;
                    } else {
                        relativePath = relativePath + "/" + obj.data.indexName;
                    }
                    addData();
                    pageUp();
                } else if(layEvent === 'detail'){ //查看
                    //do somehing
                } else if(layEvent === 'del'){ //删除
                    layer.confirm('真的删除行么', function(index){
                        obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                        layer.close(index);
                        $.get("http://localhost:8080/deleteFolder", {"folderName" : data.indexName, "account" : 15927860204, "relativePath" : relativePath})
                    });
                } else if(layEvent === 'edit'){ //编辑
                    obj.update({
                        username: '123'
                        ,title: 'xxx'
                    });
                }
            });
            table.on('tool(file)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                var data = obj.data; //获得当前行数据
                var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
                var tr = obj.tr; //获得当前行 tr 的DOM对象
                if(layEvent === 'detail'){ //查看
                    //do somehing
                } else if(layEvent === 'del'){ //删除
                    layer.confirm('真的删除行么', function(index){
                        obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
                        layer.close(index);
                        $.get("http://localhost:8080/deleteFile", {"fileName" : data.fileName, "account" : 15927860204, "relativePath" : relativePath})
                    });
                } else if(layEvent === 'edit'){ //编辑
                    obj.update({
                        username: '123'
                        ,title: 'xxx'
                    });
                }
            });
        });
    }
    addData();
    layui.use('upload', function(){
        var upload = layui.upload;
        //执行实例
        upload.render({
            accept: 'file',
            method: 'post',
            elem: '#upload', //绑定元素
            url: 'http://localhost:8002/uploadFile', //上传接口
            data: {
                "account" : 15927860204,
                "relativePath" : function () {
                    return relativePath;
                }
            }
            ,before: function(obj){
            }
            ,done: function(res){
                addData();
            }
            ,error: function(){
                //请求异常回调
            }
        });
    });

    function pageUp() {
        if (relativePath === "") {
            $("#pageUp").attr("class","layui-btn layui-btn-disabled").attr("onclick","");
        } else {
            $("#pageUp").attr("class","layui-btn layui-btn-normal").attr("onclick","back()");
        }
    }
    pageUp();
</script>
<script>
function back() {
    var index = relativePath.lastIndexOf("/");
    relativePath = relativePath.substring(0, index);
    addData();
    pageUp();
}
function createFolderForm() {
    layui.use('layer', function(){
        var layer = layui.layer;
        layer.open({
            type: 1,
            area: '500px'
            ,btn: ['提交']
            ,closeBtn: 2
            ,yes: function(index, layero){
                var folderName = $("#folderName").val();
                if (folderName === "" || folderName === null) {
                    return;
                }
                $.get("http://localhost:8002/createFolder", {
                    "account" : 15927860204,
                    "relativePath" : function () {
                        if (relativePath !== "") {
                            folderName = relativePath + "/" +  folderName;
                        }
                        return folderName;
                    }
                }, function () {
                    addData();
                    layer.close(index);
                })
            }
            ,content: '<input type="text" id = "folderName" name="folderName" required lay-verify="required" placeholder="请输入文件夹名称" autocomplete="off" class="layui-input">'
        });
    });
}
</script>
</body>
</html>